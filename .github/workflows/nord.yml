name: Test NordVPN Connection (Docker)

on:
  push:           # Runs automatically on each commit
  workflow_dispatch:  # Also allows manual triggering

jobs:
  test-nordvpn-manual:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Run NordVPN using manual repository approach with service start
        run: |
          docker run --rm --privileged ubuntu:latest bash -c '
            set -e
            export DEBIAN_FRONTEND=noninteractive

            echo "Installing base dependencies..."
            apt update && apt install -y --no-install-recommends curl wget sudo iproute2 apt-transport-https gnupg ca-certificates

            echo "Adding NordVPN repository manually..."
            echo "deb https://repo.nordvpn.com/deb/nordvpn/debian stable main" | sudo tee /etc/apt/sources.list.d/nordvpn.list

            echo "Downloading NordVPN GPG key with wget..."
            if ! wget -q -O /tmp/nordvpn_public.asc https://repo.nordvpn.com/gpg/nordvpn_public.asc; then
              echo "wget failed, trying with curl..."
              curl -fsSL https://repo.nordvpn.com/gpg/nordvpn_public.asc -o /tmp/nordvpn_public.asc
            fi

            if [ ! -s /tmp/nordvpn_public.asc ]; then
              echo "Failed to download a valid NordVPN GPG key. Exiting."
              exit 1
            fi

            echo "Importing GPG key using dearmor..."
            sudo gpg --dearmor -o /etc/apt/trusted.gpg.d/nordvpn.gpg /tmp/nordvpn_public.asc

            echo "Updating package lists..."
            sudo apt update

            echo "Attempting to install the nordvpn package..."
            if sudo apt install -y nordvpn; then
              echo "NordVPN package installed successfully."
            else
              echo "Failed to install nordvpn package. Exiting."
              exit 1
            fi

            echo "Starting NordVPN background service..."
            sudo /etc/init.d/nordvpn start || { echo "Failed to start NordVPN service."; exit 1; }
            sleep 5

            echo "Logging in and connecting..."
            sudo nordvpn login --token "${{ secrets.NORDVPN_TOKEN }}"
            sudo nordvpn set technology nordlynx
            sudo nordvpn connect
            sleep 10

            echo "Connected IP: $(curl -s https://api64.ipify.org)"
          '
