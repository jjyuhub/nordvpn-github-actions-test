name: Test NordVPN Connection (Docker)

on:
  push:           # Runs automatically on each commit
  workflow_dispatch:  # Also allows manual triggering

jobs:
  test-nordvpn-official:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Run NordVPN using official script approach
        run: |
          docker run --rm --privileged ubuntu:latest bash -c '
            set -e
            export DEBIAN_FRONTEND=noninteractive

            # Update packages and install dependencies including gnupg and lsb-release
            apt update && apt install -y --no-install-recommends curl wget sudo iproute2 apt-transport-https gnupg lsb-release

            # Run the official NordVPN install script
            wget -qO - https://downloads.nordcdn.com/apps/linux/install.sh | sudo bash

            # Update package lists and install NordVPN
            sudo apt update && sudo apt install -y nordvpn

            # Log in using NordVPN token, configure, and connect
            sudo nordvpn login --token "${{ secrets.NORDVPN_TOKEN }}"
            sudo nordvpn set technology nordlynx
            sudo nordvpn connect
            sleep 10

            # Retrieve and display the public IP address
            echo "Connected IP: $(curl -s https://api64.ipify.org)"
          '

  test-nordvpn-manual:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Run NordVPN using manual repository approach
        run: |
          docker run --rm --privileged ubuntu:latest bash -c '
            set -e
            export DEBIAN_FRONTEND=noninteractive

            # Update packages and install dependencies including gnupg
            apt update && apt install -y --no-install-recommends curl wget sudo iproute2 apt-transport-https gnupg

            # Manually add the NordVPN repository and its GPG key
            echo "deb https://repo.nordvpn.com/deb/nordvpn/debian stable main" | sudo tee /etc/apt/sources.list.d/nordvpn.list
            wget -qnc https://repo.nordvpn.com/gpg/nordvpn_public.asc -O- | sudo apt-key add -

            # Update package lists and install NordVPN
            sudo apt update && sudo apt install -y nordvpn

            # Log in using NordVPN token, configure, and connect
            sudo nordvpn login --token "${{ secrets.NORDVPN_TOKEN }}"
            sudo nordvpn set technology nordlynx
            sudo nordvpn connect
            sleep 10

            # Retrieve and display the public IP address
            echo "Connected IP: $(curl -s https://api64.ipify.org)"
          '
