name: Test NordVPN Connection (Docker)

on:
  push:         # Runs automatically on each commit
  workflow_dispatch:  # Also allows manual triggering

jobs:
  test-nordvpn:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Run NordVPN inside Docker
        run: |
          docker run --rm --cap-add=NET_ADMIN --cap-add=SYS_ADMIN ubuntu:latest bash -c '
            set -e
            
            # Install NordVPN using the official script (container runs as root so sudo isn'\''t needed)
            wget -qO - https://downloads.nordcdn.com/apps/linux/install.sh | bash

            # Update package lists and install NordVPN and curl
            apt update && apt install -y nordvpn curl

            # Log in using the NordVPN token from GitHub Secrets
            nordvpn login --token "${{ secrets.NORDVPN_TOKEN }}"

            # Configure NordVPN to use NordLynx technology
            nordvpn set technology nordlynx

            # Connect to NordVPN
            nordvpn connect

            # Wait a few seconds to ensure the connection is established
            sleep 10

            # Retrieve and display the connected public IP
            echo "Connected IP: $(curl -s https://api64.ipify.org)"
          '
